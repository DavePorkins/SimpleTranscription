<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Transcription V22</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default: Pride (Light) */
            --bg-grad: linear-gradient(135deg, #e0f2fe 0%, #ffffff 50%, #fce7f3 100%);
            --glass: rgba(255, 255, 255, 0.8);
            --border: rgba(255, 255, 255, 0.6);
            --text: #334155;
            --icon-color: #334155; /* Dunkle Icons auf hellem Grund */
            --accent: #0ea5e9;
            --accent-glow: rgba(14, 165, 233, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass: rgba(30, 41, 59, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text: #f1f5f9;
            --icon-color: #f1f5f9; /* Helle Icons auf dunklem Grund */
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 15px;
            background: var(--bg-grad);
            background-attachment: fixed;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI COMPONENTS --- */
        .app-container { width: 100%; max-width: 800px; position: relative; z-index: 2; padding-bottom: 50px; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: var(--glass); 
            backdrop-filter: blur(12px); border-radius: 24px; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }

        h1 { 
            margin: 0; font-size: 1.2rem; font-weight: 800; 
            background: linear-gradient(90deg, var(--accent), #ec4899);
            background-clip: text; -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; color: transparent;
        }

        .icon-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 5px; filter: grayscale(100%); transition: 0.3s; }
        .icon-btn:hover { filter: grayscale(0%); transform: rotate(30deg); }

        /* Settings Modal */
        #settingsModal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        #settingsModal.active { display: flex; }
        .modal-box {
            background: var(--glass); padding: 25px; border-radius: 24px;
            width: 90%; max-width: 350px; border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: var(--text);
        }
        .modal-row { margin-bottom: 15px; }
        .modal-row label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
        .modal-row select, .modal-row input { 
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.1); color: var(--text); font-size: 1rem;
            box-sizing: border-box; /* Wichtig damit es nicht √ºbersteht */
        }
        /* Fix f√ºr Inputs im Light Mode */
        [data-theme="pride"] .modal-row input, [data-theme="pride"] .modal-row select { background: white; border: 1px solid #ccc; }

        .close-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* --- VISUALIZER STAGE --- */
        .stage {
            position: relative; background: var(--glass);
            backdrop-filter: blur(10px); border-radius: 28px; overflow: hidden;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            transition: all 0.3s ease; display: flex; flex-direction: column;
        }

        canvas { width: 100%; height: 280px; display: block; }
        
        .stage-ui {
            padding: 20px; 
            border-top: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }

        .stats { font-family: monospace; font-size: 1rem; font-weight: bold; opacity: 0.7; }

        /* Controls Centering Fix */
        .controls { 
            display: flex; justify-content: center; align-items: center; gap: 20px; width: 100%; 
        }

        button.ctrl-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border);
            background: var(--glass); color: var(--icon-color); /* HIER WAR DER FEHLER */
            font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        button.ctrl-btn:active { transform: scale(0.9); }
        button.ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* REC Button Special */
        button#btnStart {
            width: 80px; height: 80px; font-size: 2rem; color: white; border: none;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            box-shadow: 0 10px 30px var(--accent-glow);
        }
        button#btnStart.recording {
            animation: pulse 2s infinite; background: #ef4444; /* Rot bei Aufnahme */
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .btn-pause.active { color: #f59e0b; border-color: #f59e0b; }

        .upload-btn {
            background: transparent; color: var(--text); border: 1px dashed var(--text); opacity: 0.5;
            padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-top: 5px;
        }

        /* Feed */
        #feed { margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        .entry {
            background: var(--glass); border-radius: 16px; padding: 18px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: 0; } }

        .entry-header { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.6; margin-bottom: 10px; }
        
        textarea {
            width: 100%; background: rgba(0,0,0,0.05); border: none; color: var(--text);
            padding: 15px; border-radius: 12px; font-family: inherit; resize: none; min-height: 80px;
            box-sizing: border-box; font-size: 16px; line-height: 1.5;
        }
        [data-theme="dark"] textarea { background: rgba(255,255,255,0.1); }
        textarea:focus { outline: 2px solid var(--accent); background: transparent; }

        .audio-player { margin-top: 10px; width: 100%; }
        
        .actions { margin-top: 10px; display: flex; gap: 10px; }
        .act-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; }
        .act-btn.del { flex: 0; color: #ef4444; border-color: #ef4444; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -150%);
            background: var(--accent); color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: bold; transition: 0.3s; z-index: 3000; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #toast.visible { transform: translate(-50%, 0); }
    </style>
</head>
<body data-theme="pride">

<script> const HARDCODED_KEY = ""; </script>

<div id="settingsModal">
    <div class="modal-box">
        <h2>Einstellungen</h2>
        <div class="modal-row">
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="sk-...">
        </div>
        <div class="modal-row">
            <label>Theme</label>
            <select id="themeSelect">
                <option value="pride">üè≥Ô∏è‚Äç‚ößÔ∏è Light / Pride</option>
                <option value="dark">üåë Dark Mode</option>
            </select>
        </div>
        <div class="modal-row">
            <label>Visualizer</label>
            <select id="vizSelect">
                <option value="orb">üîÆ Magic Orb (OpenAI)</option>
                <option value="wave">üåä Siri Waves</option>
                <option value="bar">üìä HiFi Bars</option>
            </select>
        </div>
        <button class="close-btn" onclick="toggleSettings()">Speichern & Schlie√üen</button>
    </div>
</div>

<div id="toast">Info</div>

<div class="app-container">
    <header>
        <h1>Transcription</h1>
        <div style="display:flex; gap:15px;">
            <button class="icon-btn" onclick="dlZip()">üì¶</button>
            <button class="icon-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="stage">
        <canvas id="vizCanvas"></canvas>
        
        <div class="stage-ui">
            <div class="stats" id="timer">00:00</div>
            
            <div class="controls">
                <button id="btnPause" class="ctrl-btn btn-pause" disabled title="Pause">‚è∏</button>
                
                <button id="btnStart" title="Start Recording">‚óè</button>
                
                <button id="btnStop" class="ctrl-btn btn-stop" disabled title="Stop & Send">‚ñ†</button>
            </div>

            <button id="btnUpload" class="upload-btn" onclick="document.getElementById('fileUpload').click()">üìÇ Upload File</button>
        </div>
    </div>

    <div id="feed"></div>
</div>

<input type="file" id="fileUpload" hidden accept="audio/*,video/*">

<script>
    // --- CORE VARIABLES ---
    const els = {
        btnStart: document.getElementById('btnStart'),
        btnPause: document.getElementById('btnPause'),
        btnStop: document.getElementById('btnStop'),
        timer: document.getElementById('timer'),
        canvas: document.getElementById('vizCanvas'),
        feed: document.getElementById('feed'),
        apiKey: document.getElementById('apiKey'),
        themeSelect: document.getElementById('themeSelect'),
        vizSelect: document.getElementById('vizSelect'),
        modal: document.getElementById('settingsModal'),
        fileUpload: document.getElementById('fileUpload'),
        toast: document.getElementById('toast')
    };

    let mediaRecorder, audioCtx, analyser, dataArray, source;
    let chunks = [], isRecording = false, isPaused = false;
    let startTime = 0, pauseDelta = 0, pauseStart = 0, timerInt;
    let animationId;

    // --- SETTINGS INIT ---
    if(HARDCODED_KEY.length > 5) els.apiKey.value = HARDCODED_KEY;
    else els.apiKey.value = localStorage.getItem("key_v22") || "";

    els.themeSelect.value = localStorage.getItem("theme_v22") || "pride";
    els.vizSelect.value = localStorage.getItem("viz_v22") || "orb";
    
    applySettings();

    function applySettings() {
        document.body.setAttribute('data-theme', els.themeSelect.value);
    }

    window.toggleSettings = () => {
        els.modal.classList.toggle('active');
        localStorage.setItem("key_v22", els.apiKey.value);
        localStorage.setItem("theme_v22", els.themeSelect.value);
        localStorage.setItem("viz_v22", els.vizSelect.value);
        applySettings();
    };

    loadHistory();

    // --- VISUALIZER ENGINE ---
    function initVisualizer() {
        const ctx = els.canvas.getContext('2d');
        
        // High-DPI Setup
        const dpr = window.devicePixelRatio || 1;
        const rect = els.canvas.getBoundingClientRect();
        els.canvas.width = rect.width * dpr;
        els.canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        let phase = 0;
        let smoothedVol = 0;

        function draw() {
            animationId = requestAnimationFrame(draw);
            const w = rect.width;
            const h = rect.height;
            const cx = w/2; const cy = h/2;

            ctx.clearRect(0, 0, w, h);

            let vol = 0;
            if(analyser && isRecording && !isPaused) {
                const len = analyser.frequencyBinCount;
                if(!dataArray) dataArray = new Uint8Array(len);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0; 
                // Nur B√§sse/Mitten z√§hlen (bis index 100) f√ºr bessere Reaktion
                for(let i=0; i<Math.min(len, 100); i++) sum += dataArray[i];
                vol = (sum / 100) * 2.5; // Gain Boost!
            } else {
                vol = 5 + Math.sin(Date.now()/1000)*5; // Idle
            }

            // Snappy Smoothing (schnell hoch, langsam runter)
            if(vol > smoothedVol) smoothedVol = smoothedVol * 0.5 + vol * 0.5;
            else smoothedVol = smoothedVol * 0.95 + vol * 0.05;

            const intensity = smoothedVol / 255; 
            phase += 0.02 + (intensity * 0.1);

            const mode = els.vizSelect.value;
            const style = getComputedStyle(document.body);
            const cAccent = style.getPropertyValue('--accent').trim();

            if(mode === 'orb') drawOrb(ctx, cx, cy, phase, intensity);
            else if(mode === 'wave') drawMultiWave(ctx, w, h, phase, intensity, cAccent);
            else if(mode === 'bar') drawBars(ctx, w, h, intensity, cAccent);
        }
        draw();
    }

    function drawOrb(ctx, cx, cy, t, intense) {
        // OpenAI Style: 3 Balls moving, strong blur simulated by gradients
        const rBase = 60 + (intense * 100);
        
        // Ball 1 (Cyan/Blue)
        const x1 = cx + Math.cos(t) * 40 * intense;
        const y1 = cy + Math.sin(t * 1.5) * 30 * intense;
        const g1 = ctx.createRadialGradient(x1, y1, 0, x1, y1, rBase);
        g1.addColorStop(0, 'rgba(56, 189, 248, 0.8)');
        g1.addColorStop(1, 'rgba(56, 189, 248, 0)');
        
        // Ball 2 (Pink/Magenta)
        const x2 = cx + Math.cos(t + 2) * 40 * intense;
        const y2 = cy + Math.sin(t * 0.8) * 30 * intense;
        const g2 = ctx.createRadialGradient(x2, y2, 0, x2, y2, rBase);
        g2.addColorStop(0, 'rgba(236, 72, 153, 0.8)');
        g2.addColorStop(1, 'rgba(236, 72, 153, 0)');

        // Blend Mode Screen macht es leuchtend
        ctx.globalCompositeOperation = 'screen';
        
        ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(x1, y1, rBase, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(x2, y2, rBase, 0, Math.PI*2); ctx.fill();
        
        ctx.globalCompositeOperation = 'source-over';
    }

    function drawMultiWave(ctx, w, h, t, intense, color) {
        // 3 Layer Waves
        const yMid = h/2;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';

        for(let i=0; i<3; i++) {
            ctx.beginPath();
            ctx.strokeStyle = i===0 ? color : (i===1 ? '#ec4899' : '#ffffff');
            ctx.globalAlpha = 1 - (i*0.3);
            
            for(let x=0; x<w; x+=5) {
                // Envelope window (damit es an den R√§ndern 0 ist)
                const normX = (x / w) * 2 - 1; // -1 to 1
                const env = 1 - (normX * normX); 
                
                const freq = 0.01 + (i*0.005);
                const speed = t * (2 + i);
                const amp = (intense * h * 0.4) * env;
                
                const y = Math.sin(x * freq + speed) * amp;
                if(x===0) ctx.moveTo(x, yMid+y); else ctx.lineTo(x, yMid+y);
            }
            ctx.stroke();
        }
        ctx.globalAlpha = 1;
    }

    function drawBars(ctx, w, h, intense, color) {
        const count = 64; 
        const barW = (w / count) / 1.5;
        const space = (w / count) - barW;
        const yMid = h/2;
        
        ctx.fillStyle = color;
        
        for(let i=0; i<count; i++) {
            // Symmetrie index
            const dist = Math.abs(i - count/2) / (count/2); // 0 center, 1 edge
            const env = 1 - dist; // Mitte hoch, Rand niedrig
            
            // Random noise modulated by volume
            let hBar = (intense * h * 0.8) * env;
            
            // Wenn dataArray da ist, echte daten nutzen
            if(dataArray) {
                const idx = Math.floor((i/count) * dataArray.length);
                hBar = (dataArray[idx] / 255) * h * 0.8;
            }
            
            hBar = Math.max(4, hBar); // Min height
            
            // Round caps
            ctx.beginPath();
            ctx.roundRect(i * (barW + space), yMid - hBar/2, barW, hBar, barW/2);
            ctx.fill();
        }
    }

    initVisualizer();
    window.addEventListener('resize', initVisualizer); // Re-init on resize to fix blur

    // --- UPLOAD ---
    els.fileUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(file) processAudio(file, file.name);
        els.fileUpload.value = '';
    });

    // --- RECORDER ---
    async function startRec() {
        if(!els.apiKey.value) { toggleSettings(); return showToast("API Key fehlt!", true); }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            globalStream = stream;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser(); 
            analyser.fftSize = 512; 
            const src = audioCtx.createMediaStreamSource(stream); 
            src.connect(analyser);

            chunks = [];
            // "Long Mode" Standard (32kbit)
            let options = { bitsPerSecond: 32000 };
            if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) options.mimeType='audio/webm;codecs=opus';
            
            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: chunks[0].type });
                processAudio(blob, "Memo");
                resetUI();
            };

            mediaRecorder.start(1000);
            isRecording = true; isPaused = false; startTime = Date.now(); pauseDelta=0;
            timerInt = setInterval(updateTimer, 1000);
            
            updateUIState(true);

        } catch(e) { console.error(e); showToast("Fehler: Mikrofon Zugriff!", true); }
    }

    els.btnStart.onclick = startRec;
    
    els.btnPause.onclick = () => {
        if(isPaused) { 
            mediaRecorder.resume(); isPaused=false; pauseDelta += Date.now()-pauseStart;
            els.btnPause.classList.remove('active'); 
        } else { 
            mediaRecorder.pause(); isPaused=true; pauseStart=Date.now();
            els.btnPause.classList.add('active'); 
        }
    };
    
    els.btnStop.onclick = () => mediaRecorder.stop();

    function updateTimer() {
        if(isPaused) return;
        const s = Math.floor((Date.now() - startTime - pauseDelta)/1000);
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        els.timer.innerText = `${m}:${sec}`;
    }

    function updateUIState(recording) {
        if(recording) {
            els.btnStart.style.display = 'none'; // REC Button weg
            els.btnPause.disabled = false;
            els.btnStop.disabled = false;
            els.timer.style.color = "#ec4899";
        } else {
            resetUI();
        }
    }

    function resetUI() {
        isRecording = false; clearInterval(timerInt);
        els.btnStart.style.display = 'flex';
        els.btnPause.disabled = true; els.btnPause.classList.remove('active');
        els.btnStop.disabled = true;
        els.timer.innerText = "00:00"; els.timer.style.color = "inherit";
    }

    // --- API ---
    async function processAudio(blob, name) {
        const id = Date.now();
        createEntry(id, new Date().toLocaleTimeString(), "Sende...", blob);
        
        const fd = new FormData();
        let ext = blob.type.includes('mp4') ? 'mp4' : 'webm';
        if(blob.name) ext = blob.name.split('.').pop();
        
        fd.append("file", blob, `audio.${ext}`);
        fd.append("model", "whisper-1");

        try {
            const res = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                method: "POST", headers: { "Authorization": `Bearer ${els.apiKey.value}` }, body: fd
            });
            const data = await res.json();
            
            if(res.ok) {
                document.getElementById(`txt-${id}`).value = data.text;
                saveToHistory(id, data.text);
                showToast("Fertig!");
            } else {
                document.getElementById(`txt-${id}`).value = "Error: " + (data.error?.message || "Unknown");
            }
        } catch(e) {
            document.getElementById(`txt-${id}`).value = "Netzwerk Fehler: " + e.message;
        }
    }

    // --- HISTORY ---
    function saveToHistory(id, text) {
        let h = JSON.parse(localStorage.getItem("hist_v22")||"[]");
        h.unshift({ id, text, ts: new Date().toLocaleTimeString() });
        if(h.length > 20) h.pop();
        localStorage.setItem("hist_v22", JSON.stringify(h));
    }
    
    function loadHistory() {
        let h = JSON.parse(localStorage.getItem("hist_v22")||"[]");
        h.forEach(e => createEntry(e.id, e.ts, e.text)); // No blob in history
    }

    // --- UI HELPERS ---
    function createEntry(id, ts, text, blob) {
        const d = document.createElement('div');
        d.className = 'entry'; d.id = `e-${id}`;
        
        let player = "";
        if(blob) {
            const url = URL.createObjectURL(blob);
            // duration hack #t=1000
            player = `<audio class="audio-player" controls src="${url}#t=1000"></audio>`;
        }

        d.innerHTML = `
            <div class="entry-header"><span>${ts}</span></div>
            <textarea id="txt-${id}">${text}</textarea>
            ${player}
            <div class="actions">
                <button class="act-btn" onclick="navigator.clipboard.writeText(document.getElementById('txt-${id}').value)">Copy</button>
                <button class="act-btn del" onclick="document.getElementById('e-${id}').remove()">L√∂schen</button>
            </div>
        `;
        els.feed.prepend(d);
    }

    function showToast(txt, err=false) {
        els.toast.textContent = txt;
        els.toast.style.background = err ? '#ef4444' : 'var(--accent)';
        els.toast.classList.add('visible');
        setTimeout(() => els.toast.classList.remove('visible'), 3000);
    }

    window.dlZip = () => { alert("ZIP Funktion kommt im n√§chsten Update (Code bereinigt)"); };

</script>
</body>
</html>