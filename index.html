<!DOCTYPE html>
<html lang="de" data-theme="light-clear">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Transcription</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" id="theme-color-meta" content="#a18cd1">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');

        html { scroll-behavior: smooth; transition: background 0.5s ease; }

        :root {
            /* Fallback Colors */
            --c1: #a18cd1; --c2: #fbc2eb;
            --plasma1: #8ec5fc; --plasma2: #e0c3fc; --plasma3: #99ddff;
            
            /* 1. Light Clear (Maximales Glas) */
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.35);
            --text: #111111; --text-muted: #555555;
            --input-bg: rgba(255, 255, 255, 0.4);
            --btn-glass: rgba(255, 255, 255, 0.6);
            --btn-hover: rgba(255, 255, 255, 0.9);
            --btn-text: #111;
            --rec-btn-bg: linear-gradient(135deg, var(--c2), var(--c1));
            --accent: #c471ed; --danger: #ff4757; --warn: #ffa502; --safe: #2ed573;
            --badge-bg: rgba(255, 255, 255, 0.5);
            --title-bg: rgba(255, 255, 255, 0.5);
        }

        /* 2. Light Glass */
        html[data-theme="light-glass"] {
            --glass-bg: rgba(255, 255, 255, 0.55);
            --input-bg: rgba(255, 255, 255, 0.65);
            --btn-glass: rgba(255, 255, 255, 0.8);
            --btn-hover: rgba(230, 230, 240, 1);
            --title-bg: rgba(255, 255, 255, 0.7);
        }

        /* 3. Dark Glass */
        html[data-theme="dark-glass"] {
            color-scheme: dark; background: #000000;
            --glass-bg: rgba(45, 45, 50, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text: #fdfdfd; --text-muted: #cccccc;
            --input-bg: rgba(0, 0, 0, 0.4);
            --btn-glass: rgba(255, 255, 255, 0.15);
            --btn-hover: rgba(255, 255, 255, 0.25);
            --btn-text: #fff;
            --badge-bg: rgba(0, 0, 0, 0.5);
            --rec-btn-bg: #555; 
            --title-bg: rgba(0, 0, 0, 0.5);
        }

        /* 4. Dark Clear (Tiefschwarz) */
        html[data-theme="dark-clear"] {
            color-scheme: dark; background: #000000;
            --glass-bg: rgba(10, 10, 15, 0.35);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff; --text-muted: #dddddd;
            --input-bg: rgba(0, 0, 0, 0.4);
            --btn-glass: rgba(255, 255, 255, 0.1);
            --btn-hover: rgba(255, 255, 255, 0.2);
            --btn-text: #fff;
            --badge-bg: rgba(255, 255, 255, 0.15);
            --rec-btn-bg: #333; 
            --title-bg: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            color: var(--text); margin: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            -webkit-tap-highlight-color: transparent; padding-bottom: 80px;
        }

        #cloudCanvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            pointer-events: none; opacity: 1; transition: filter 0.5s ease;
        }
        /* Dunklerer Canvas-Filter f√ºr starken Kontrast im Dark Mode */
        html[data-theme^="dark"] #cloudCanvas { filter: brightness(0.4) saturate(1.2); }

        .app-container { 
            width: 100%; max-width: 800px; 
            display: flex; flex-direction: column; 
            padding: 10px; box-sizing: border-box; position: relative;
        }

        /* --- STICKY ZONE --- */
        .sticky-zone {
            position: sticky; top: 10px; z-index: 100;
            display: flex; flex-direction: column; gap: 12px; width: 100%;
        }

        .glass-panel {
            border-radius: 28px; border: 1px solid var(--glass-border);
            background: var(--glass-bg); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            padding: 15px; box-sizing: border-box; width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* TITEL PILLE (Immer lesbar) */
        .top-row { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; gap: 12px; margin-bottom: 5px;}
        .title-pill {
            background: var(--title-bg); border: 1px solid var(--glass-border);
            padding: 8px 24px; border-radius: 50px; display: inline-flex; align-items: baseline; gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        h1 { 
            margin: 0; font-size: 1.4rem; font-weight: 900; letter-spacing: -0.5px;
            background: linear-gradient(90deg, var(--c2), var(--c1)); 
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent;
        }
        html[data-theme^="dark"] h1 { background: linear-gradient(90deg, #fff, var(--c2), #fff); -webkit-background-clip: text; }
        .version-tag { font-size: 0.5em; opacity: 0.9; font-weight: 800; color: var(--text); -webkit-text-fill-color: initial;}

        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; width: 100%;}
        .icon-btn { 
            background: var(--btn-glass); border: 1px solid var(--glass-border); color: var(--text); 
            border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display:flex; align-items:center; justify-content:center; 
            transition: 0.2s;
        }
        .icon-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;}
        .icon-btn:hover { transform: scale(1.1); background: var(--btn-hover); color: var(--btn-text);}

        /* ACTION BAR (Auto-Save, Auto-Cut) */
        .btn-sleek { 
            display:flex; gap:6px; color:var(--text); align-items:center; justify-content: center; 
            cursor: pointer; background: var(--btn-glass); padding: 6px 16px; border-radius: 14px; 
            border: 1px solid var(--glass-border); font-size: 0.85rem; font-weight: 700; 
            white-space: nowrap; transition: 0.2s; height: 36px; box-sizing: border-box;
        }
        .btn-sleek:hover { background: var(--btn-hover); color: var(--btn-text); }
        .btn-sleek.inactive { opacity: 0.5; filter: grayscale(1); background: var(--input-bg); border-color: transparent;}
        .btn-sleek.inactive:hover { opacity: 1; filter: none; background: var(--btn-glass);}
        .btn-sleek svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;}

        /* TIMER BLOCK */
        .action-center { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%;}
        .timer { font-size: 3.5rem; font-weight: 300; letter-spacing: 2px; line-height: 1; font-variant-numeric: tabular-nums; color: var(--text); text-shadow: 0 4px 15px rgba(0,0,0,0.1);}
        
        .rec-controls { display: flex; justify-content: center; align-items: center; gap: 15px; width: 100%; }
        .btn-circle { border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: var(--btn-glass); color: var(--text); border-radius: 50%; width: 45px; height: 45px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--glass-border);}
        .btn-circle:hover { background: var(--btn-hover); }
        .btn-circle:active { transform: scale(0.9); }
        .btn-circle svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2;}

        #btnMain { width: 65px; height: 65px; background: var(--rec-btn-bg); color: white; border:none;}
        #btnMain:hover { opacity: 0.9; }
        #btnMain.state-recording { background: var(--btn-glass); color: var(--danger); border-radius: 22px; border: 1px solid var(--glass-border);}
        #btnMain.state-recording:hover { background: var(--btn-hover); }
        #btnMain svg { stroke: currentColor; fill: none; width: 28px; height: 28px; stroke-width:2;}
        #btnMain.state-recording svg { fill: currentColor; stroke: none;}

        .side-btn { opacity: 0; pointer-events: none; transform: scale(0.5); width: 0; margin: 0; }
        .side-btn.visible { opacity: 1; pointer-events: all; transform: scale(1); width: 45px; margin: 0 5px; }
        .side-btn.visible#btnCancel { color: var(--danger); font-size: 1.1rem; font-weight: bold;}
        .side-btn.visible#btnPause { color: var(--warn); }
        #btnPause.state-paused { background: var(--warn); color: white; border-color: transparent;}

        /* --- THE MAGIC SCROLL CUTOFF --- */
        .scroll-wrapper {
            width: 100%; display: flex; flex-direction: column; gap: 15px;
            /* Fade-Out Maske: Oben 60px unsichtbar, dann weicher √úbergang */
            mask-image: linear-gradient(to bottom, transparent 0%, black 60px);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 60px);
            padding-top: 60px; margin-top: -45px; z-index: 1;
        }

        /* ACTIVE TEXT ENTRY */
        #activeEntry { display: none; flex-direction: column; gap: 12px;}
        .active-top-bar { display: flex; justify-content: center; align-items: center; width: 100%; flex-direction: column; gap: 8px; }
        
        .status-container { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;}
        .status-badge { font-size: 0.85rem; font-weight: 700; display:flex; align-items:center; gap:6px; padding: 4px 12px; border-radius: 20px; background: var(--badge-bg); border: 1px solid var(--glass-border); color: var(--text); box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
        .status-badge.highlight { color: var(--accent); border-color: var(--accent); animation: pulse 1.5s infinite;}
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        
        .stats-badges { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .stat-pill { background: var(--badge-bg); padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); display:flex; align-items:center; gap:4px; border: 1px solid var(--glass-border);}
        
        /* Endlos-Textfeld (Keine Scrollbar, w√§chst mit) */
        .seamless-text { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text); 
            font-family: inherit; resize: none; min-height: 80px; overflow-y: hidden; height: auto;
            box-sizing: border-box; line-height: 1.6; font-size: 15px; outline: none; padding: 18px; border-radius: 24px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }

        /* HISTORY FEED */
        #feed { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .entry { background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 28px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid var(--glass-border); box-sizing: border-box; width: 100%; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; gap: 12px;}
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: 0; } }

        .entry-header { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 10px;}
        .entry-meta-info { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .date-badge { font-size: 0.85rem; color: var(--text); font-weight: 800; display:flex; align-items:center; gap:6px;}
        
        .entry-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;}
        .mini-btn { background: var(--badge-bg); border: 1px solid var(--glass-border); color: var(--text); border-radius: 12px; width: 34px; height: 34px; cursor: pointer; display:flex; align-items:center; justify-content:center; transition: 0.2s;}
        .mini-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;}
        .mini-btn:hover { background: var(--btn-hover); color: var(--btn-text); transform: translateY(-2px);}
        .mini-btn.danger { color: var(--danger); }
        .mini-btn.safe { color: var(--safe); }
        .mini-btn.action { color: var(--accent); }

        details.custom-accordion { background: var(--badge-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 10px 15px; width: 100%; box-sizing: border-box;}
        details.custom-accordion summary { font-size: 0.85rem; font-weight: 700; color: var(--text); cursor: pointer; outline: none; user-select: none; display: flex; align-items: center; justify-content: center; gap:6px;}
        details.custom-accordion summary svg { width: 16px; height: 16px; }
        .audio-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .audio-part { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 6px 12px; border-radius: 10px;}
        .audio-part span { font-size: 0.75rem; font-weight: bold; color: var(--text-muted); flex-shrink: 0;}
        audio { width: 100%; height: 30px; border-radius: 6px; outline: none; }

        /* MODALS - ECHTES PREVIEW */
        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; top: 0; background: rgba(0,0,0,0.05); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);}
        .modal.visible { display: flex; animation: fadeIn 0.2s; }
        .modal-box { background: var(--glass-bg); padding: 25px; border-radius: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 90%; max-width: 440px; border: 1px solid var(--glass-border); max-height: 85vh; overflow-y: auto; color: var(--text); box-sizing: border-box;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 800; font-size: 1.2rem; color: var(--text);}
        
        /* HONEYCOMB ISLAND (Exakt & Sauber) */
        .honeycomb-island { display: flex; flex-direction: column; align-items: center; padding: 15px 0 30px 0; }
        .hex-row { display: flex; justify-content: center; margin-bottom: -12px; z-index: 2; position: relative;}
        .hex { 
            width: 48px; height: 54px; cursor: pointer; transition: 0.2s; margin: 0 2px;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            background: rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center;
        }
        html[data-theme^="dark"] .hex { background: rgba(0,0,0,0.5); }
        .hex:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 0 20px rgba(255,255,255,0.8);}
        /* 92% width for the border effect */
        .hex-inner { width: 90%; height: 90%; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
        
        /* Pastel Rainbow */
        .rainbow-hex { background: linear-gradient(124deg, #ffb3ba, #ffdfba, #ffffba, #baffc9, #bae1ff, #d0baff); background-size: 400% 400%; animation: rainbow 3s ease infinite;}
        @keyframes rainbow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        .studio-tabs { display: flex; background: var(--input-bg); border-radius: 14px; padding: 4px; margin-bottom: 20px;}
        .tab-btn { flex: 1; text-align: center; font-size: 0.85rem; font-weight: 700; padding: 10px; cursor: pointer; border-radius: 10px; color: var(--text-muted); transition: 0.2s;}
        .tab-btn.active { background: var(--btn-glass); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05);}

        .anim-option { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: var(--input-bg); border-radius: 14px; margin-bottom: 8px; cursor: pointer; border: 1px solid var(--glass-border); transition: 0.2s; font-weight: 700;}
        .anim-option:hover { background: var(--btn-hover); color: var(--btn-text); }
        .anim-option.active { border-color: var(--accent); color: var(--accent); background: var(--btn-glass); }

        .api-input-box { width: 100%; padding: 14px; border-radius: 16px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text); font-size: 1rem; outline: none; box-sizing: border-box; margin-bottom: 10px; font-family: monospace;}
        .info-text { font-size: 0.9rem; color: var(--text); line-height: 1.5; margin-bottom: 15px; font-weight: 600; text-align: center;}
        .info-text a { color: var(--accent); text-decoration: none; font-weight: 800;}

        /* Edles Toast SVG */
        #toast { position: fixed; top: 20px; left: 50%; transform: translate(-50%, -150%); background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); color: var(--text); padding: 12px 30px; border-radius: 50px; font-weight: 800; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.2s; opacity: 0; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; pointer-events: none; display: flex; align-items: center; gap: 8px;}
        #toast.visible { transform: translate(-50%, 0); opacity: 1; }
    </style>
</head>
<body>

<canvas id="cloudCanvas"></canvas>
<script> const HARDCODED_KEY = ""; </script>
<div id="toast"><svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg> <span id="toastMsg">Kopiert</span></div>

<div id="devPanel" class="modal">
    <div class="modal-box" style="padding: 25px 15px;">
        <div class="modal-header">
            <span style="display:flex; align-items:center; gap:8px;"><svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 1.25-.895 2.25-2 2.25h-1.63c-.45 0-.82.37-.82.82 0 .22.09.43.24.58.3.31.48.73.48 1.18 0 1.17-.95 2.13-2.12 2.13H12zm-3-12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-9 5a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg> Color Studio</span>
            <div style="display:flex; gap:8px;">
                <button class="icon-btn" onclick="resetDev()" style="width:auto; height:32px; border-radius:12px; font-size:0.8rem; font-weight:bold; padding: 0 10px;">Reset</button>
                <button class="icon-btn" onclick="toggleModal('devPanel')" style="width:32px;height:32px;"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
        </div>
        
        <div class="studio-tabs">
            <div class="tab-btn active" id="tabColors" onclick="switchStudioTab('colors')">Farben</div>
            <div class="tab-btn" id="tabAnims" onclick="switchStudioTab('anims')">Animation</div>
        </div>

        <div id="viewColors" class="honeycomb-island">
            <div id="hexContainer" style="display: flex; flex-direction: column; align-items: center;"></div>
        </div>

        <div id="viewAnims" style="display:none; padding: 10px 0;">
            <div class="anim-option active" id="anim-nebula" onclick="setAnim('nebula')">Nebula (Wolken) <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg></div>
            <div class="anim-option" id="anim-lava" onclick="setAnim('lava')">Lava (Tropfen) <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"></circle></svg></div>
            <div class="anim-option" id="anim-aurora" onclick="setAnim('aurora')">Aurora (Wellen) <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h4l3-9 5 18 3-9h5"></path></svg></div>
            
            <div style="margin-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem; font-weight:bold;">Tipp: Die Animation reagiert auf deine Stimme!</div>
        </div>
    </div>
</div>

<div id="apiModal" class="modal">
    <div class="modal-box">
        <div class="modal-header"><span>OpenAI API Key</span><button class="icon-btn" onclick="toggleModal('apiModal')" style="width:32px;height:32px;"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
        <input type="password" id="apiKey" class="api-input-box" placeholder="sk-...">
        <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
            <button class="btn-sleek active" onclick="saveApiAndClose()" style="width:48%; height: 40px; font-size:1rem;">Speichern</button>
            <button class="btn-sleek" onclick="toggleApiVisibility()" style="width:48%; height: 40px; font-size:1rem;">Sichtbar</button>
        </div>
        <div class="info-text">
            Simple Transcription nutzt die <a href="https://platform.openai.com/" target="_blank">Whisper API von OpenAI</a>. Daf√ºr brauchst du deinen eigenen Key. Audio wird nicht lokal gespeichert, sondern direkt verarbeitet.<br><br>
            <b>Kosten:</b> Ca. <b>0,6 Cent pro Minute</b>.
        </div>
    </div>
</div>

<div id="qrModal" class="modal">
    <div class="modal-box" style="text-align:center;">
        <div class="modal-header"><span>App teilen</span><button class="icon-btn" onclick="toggleModal('qrModal')" style="width:32px;height:32px;"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
        <div id="qrcode" style="display:flex; justify-content:center; padding: 20px; background: white; border-radius: 20px; margin-bottom: 20px;"></div>
        <p style="font-size:1.3rem; font-weight:900; color:var(--text); margin-bottom: 8px;">Simple Transcription</p>
        <p style="font-size:0.95rem; color:var(--text); line-height: 1.5; font-weight:600;">
            ist eine Web-App, die von mir ge-vibe-coded wurde. Ist ein kleines Experiment und soll dazu motivieren, dass andere damit experimentieren und ausprobieren.
        </p>
    </div>
</div>

<div class="app-container">
    
    <div class="sticky-zone">
        <div class="glass-panel" style="padding-bottom: 10px;">
            <div class="top-row">
                <div class="title-pill">
                    <h1>Simple Transcription</h1>
                    <span class="version-tag">V67</span>
                </div>
                
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleModal('apiModal')" title="API Key & Info">
                        <svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                    </button>
                    <button class="icon-btn" onclick="cycleTheme()" title="Theme Rotator" id="themeIcon"></button>
                    <button class="icon-btn" onclick="toggleModal('devPanel')" title="Color Studio">
                        <svg viewBox="0 0 24 24"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 1.25-.895 2.25-2 2.25h-1.63c-.45 0-.82.37-.82.82 0 .22.09.43.24.58.3.31.48.73.48 1.18 0 1.17-.95 2.13-2.12 2.13H12zm-3-12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-9 5a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                    </button>
                    <button class="icon-btn" onclick="dlAllZip()" title="Master ZIP Download">
                        <svg viewBox="0 0 24 24"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
                    </button>
                    <button class="icon-btn" onclick="showQR()" title="App Teilen">
                        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    </button>
                    <button class="icon-btn" title="Mikrofon Auswahl" style="position:relative;">
                        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        <select id="micSelect" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="default">Default</option></select>
                    </button>
                </div>

                <div class="header-actions" style="margin-top: 4px;">
                    <div class="btn-sleek inactive" id="btnAutoSave" onclick="toggleSave()" title="Auto-Save Backup">
                        <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Auto
                    </div>
                    <div class="btn-sleek" id="btnAutoCut" onclick="cycleAutoCut()" title="Auto-Cut Intervall">
                        <svg viewBox="0 0 24 24"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg> 
                        <span id="cutDisplay">2 Min</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel" id="glassBlock">
            <div class="action-center">
                <div class="timer" id="timer">00:00</div>
                <div class="rec-controls">
                    <button id="btnCancel" class="btn-circle side-btn" title="Verwerfen" onclick="cancelRec(this)">
                        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                    <button id="btnMain" class="btn-circle" title="Aufnahme / Stop">
                        <svg id="iconMain" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button id="btnPause" class="btn-circle side-btn" title="Pause / Weiter">
                        <svg id="iconPause" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
            </div>
        </div>
    </div> <div class="scroll-wrapper">
        
        <div id="activeEntry" class="glass-panel" style="display:none; padding-top: 20px;">
            <div class="active-top-bar" style="margin-bottom: 15px;">
                <div class="status-container" id="statusContainer">
                    <span class="status-badge" id="badgeListen"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> H√∂re zu...</span>
                    <span class="status-badge highlight" id="badgeTranscribe" style="display:none;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> Transkribiere...</span>
                    <span class="status-badge" id="badgeCut" style="display:none; color:var(--warn); border-color:var(--warn);"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg> Cut...</span>
                </div>
                <div class="stats-badges" id="liveBadges">
                    <span class="stat-pill" id="liveWords">0 W</span>
                    <span class="stat-pill" id="liveTokens">0 T</span>
                    <span class="stat-pill" id="livePages">0 S</span>
                    <span class="stat-pill" id="liveCost">0.0 ct</span>
                </div>
            </div>
            <textarea id="activeText" class="seamless-text" readonly placeholder="Sprich in das Mikrofon..."></textarea>
        </div>

        <div id="feed"></div>
        
    </div> </div>

<input type="file" id="fileUpload" hidden accept=".flac,.m4a,.mp3,.mp4,.mpeg,.mpga,.oga,.ogg,.wav,.webm,.opus,.amr">

<script>
    // Force Scroll to Top on Refresh
    window.onload = () => { setTimeout(() => window.scrollTo(0, 0), 50); };

    const els = {
        btnMain: document.getElementById('btnMain'), btnPause: document.getElementById('btnPause'), btnCancel: document.getElementById('btnCancel'),
        iconMain: document.getElementById('iconMain'), iconPause: document.getElementById('iconPause'), themeIcon: document.getElementById('themeIcon'),
        timer: document.getElementById('timer'), liveBadges: document.getElementById('liveBadges'), liveWords: document.getElementById('liveWords'), liveCost: document.getElementById('liveCost'), liveTokens: document.getElementById('liveTokens'), livePages: document.getElementById('livePages'),
        glassBlock: document.getElementById('glassBlock'), canvas: document.getElementById('cloudCanvas'), feed: document.getElementById('feed'), activeEntry: document.getElementById('activeEntry'), activeText: document.getElementById('activeText'),
        badgeListen: document.getElementById('badgeListen'), badgeTranscribe: document.getElementById('badgeTranscribe'), badgeCut: document.getElementById('badgeCut'),
        apiKey: document.getElementById('apiKey'), fileUpload: document.getElementById('fileUpload'),
        toast: document.getElementById('toast'), toastMsg: document.getElementById('toastMsg'), btnAutoSave: document.getElementById('btnAutoSave'), btnAutoCut: document.getElementById('btnAutoCut'), cutDisplay: document.getElementById('cutDisplay'),
        devPanel: document.getElementById('devPanel'), hexContainer: document.getElementById('hexContainer'), apiModal: document.getElementById('apiModal'), micSelect: document.getElementById('micSelect')
    };

    // Theme Rotator
    const svgThemes = [
        `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`, 
        `<path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"></path>`, 
        `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`, 
        `<circle cx="12" cy="12" r="10" fill="currentColor"></circle>` 
    ];
    const themes = ['light-clear', 'light-glass', 'dark-glass', 'dark-clear'];

    const svgCopy = `<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>`;
    const svgTxt = `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>`;
    const svgAudio = `<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle>`;
    const svgTrash = `<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>`;
    const svgRetry = `<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path>`;
    const svgZip = `<path d="M21 8v13H3V8"></path><polyline points="1 3 23 3 23 8 1 8 1 3"></polyline><line x1="10" y1="12" x2="14" y2="12"></line>`;

    function toggleModal(id) { document.getElementById(id).classList.toggle('visible'); }
    function toggleApiVisibility() { els.apiKey.type = els.apiKey.type === 'password' ? 'text' : 'password'; }
    function saveApiAndClose() { localStorage.setItem("key_v38", els.apiKey.value); toggleModal('apiModal'); showToast("Key gespeichert"); }

    // Theme Engine Memory
    let currentThemeIdx = parseInt(localStorage.getItem('theme_idx_v67') || 0);
    function cycleTheme() { currentThemeIdx = (currentThemeIdx + 1) % themes.length; applyTheme(currentThemeIdx); }
    function applyTheme(idx) {
        document.documentElement.setAttribute('data-theme', themes[idx]);
        els.themeIcon.innerHTML = `<svg viewBox="0 0 24 24">${svgThemes[idx]}</svg>`;
        localStorage.setItem('theme_idx_v67', idx);
        updateDev(true); 
    }
    applyTheme(currentThemeIdx);

    // Auto-Save Toggle
    let isAutoSave = localStorage.getItem("autodl_v67") === 'true';
    function updateSaveBtn() { els.btnAutoSave.className = isAutoSave ? 'btn-sleek' : 'btn-sleek inactive'; }
    window.toggleSave = () => { isAutoSave = !isAutoSave; localStorage.setItem("autodl_v67", isAutoSave); updateSaveBtn(); showToast(isAutoSave ? "Auto-Save An" : "Auto-Save Aus"); };
    updateSaveBtn();

    // Auto-Cut (0-5, Default: 2)
    const cutOptions = [0, 1, 2, 3, 4, 5];
    let currentCutIdx = localStorage.getItem("autocut_idx_v67");
    if(currentCutIdx === null) currentCutIdx = 2; else currentCutIdx = parseInt(currentCutIdx);
    function updateCutBtn() { 
        let val = cutOptions[currentCutIdx];
        els.btnAutoCut.className = val > 0 ? 'btn-sleek' : 'btn-sleek inactive';
        els.cutDisplay.innerText = val > 0 ? `${val} Min` : 'Off';
    }
    window.cycleAutoCut = () => { currentCutIdx = (currentCutIdx + 1) % cutOptions.length; localStorage.setItem("autocut_idx_v67", currentCutIdx); updateCutBtn(); };
    updateCutBtn();

    // Studio Tabs
    window.switchStudioTab = (tab) => {
        document.getElementById('tabColors').classList.toggle('active', tab === 'colors');
        document.getElementById('tabAnims').classList.toggle('active', tab === 'anims');
        document.getElementById('viewColors').style.display = tab === 'colors' ? 'flex' : 'none';
        document.getElementById('viewAnims').style.display = tab === 'anims' ? 'block' : 'none';
    };

    // Color Setup (Exakte Hexagon-Generierung)
    function applyPreset(c1, c2, b1, b2, b3) { 
        document.documentElement.style.setProperty('--c1', c1); document.documentElement.style.setProperty('--c2', c2);
        localStorage.setItem('d_c1', c1); localStorage.setItem('d_c2', c2); 
        localStorage.setItem('d_b1', b1); localStorage.setItem('d_b2', b2); localStorage.setItem('d_b3', b3); 
        updateDev(); 
    }

    const hexPresets = [
        // Reihe 1: Mono (3)
        [ {t:['#fff','#ccc'], b:['#0a0a0a','#1a1a1a']}, {t:['#fff','#eee'], b:['#444','#555']}, {t:['#111','#444'], b:['#fff','#eee']} ],
        // Reihe 2: Silver & Ice (4)
        [ {t:['#fff','#ccc'], b:['#2c3e50','#000000']}, {t:['#111','#444'], b:['#bdc3c7','#7f8c8d']}, {t:['#111','#333'], b:['#cfd9df','#e2ebf0']}, {t:['#fff','#eee'], b:['#274046','#e6dada']} ],
        // Reihe 3: Creme & Natur (5)
        [ {t:['#111','#333'], b:['#f5f7fa','#c3cfe2']}, {t:['#222','#555'], b:['#ffecd2','#fcb69f']}, {t:['#111','#333'], b:['#fccb90','#d57eeb']}, {t:['#111','#222'], b:['#d4fc79','#96e6a1']}, {t:['#111','#333'], b:['#a8edea','#fed6e3']} ],
        // Reihe 4: Pastell (6)
        [ {t:['#111','#333'], b:['#a18cd1','#fbc2eb']}, {t:['#111','#333'], b:['#84fab0','#8fd3f4']}, {t:['#111','#333'], b:['#ff9a9e','#fecfef']}, {t:['#111','#333'], b:['#fbc2eb','#a6c1ee']}, {t:['#111','#333'], b:['#4facfe','#00f2fe']}, {t:['#111','#333'], b:['#fa709a','#fee140']} ],
        // Reihe 5: Deep Vibes (5)
        [ {t:['#fff','#ccc'], b:['#30cfd0','#330867']}, {t:['#fff','#eee'], b:['#5ee7df','#b490ca']}, {t:['#fff','#eee'], b:['#13547a','#80d0c7']}, {t:['#fff','#ffccaa'], b:['#eb3349','#f45c43']}, {t:['#fff','#eee'], b:['#4cb8c4','#3cd3ad']} ]
    ];

    hexPresets.forEach((row, rIdx) => {
        let rDiv = document.createElement('div');
        rDiv.className = 'hex-row';
        rDiv.style.zIndex = 10 - rIdx;
        row.forEach(p => {
            let h = document.createElement('div'); h.className = 'hex';
            h.innerHTML = `<div class="hex-inner" style="background: linear-gradient(135deg, ${p.b[0]}, ${p.b[1]});"></div>`;
            h.onclick = () => applyPreset(p.t[0], p.t[1], p.b[0], p.b[1], p.b[0]); // b3 is just b1 again for simplicity
            rDiv.appendChild(h);
        });
        els.hexContainer.appendChild(rDiv);
    });
    // Rainbow Row (1)
    let rainbowRow = document.createElement('div'); rainbowRow.className = 'hex-row'; rainbowRow.style.zIndex = 1;
    rainbowRow.innerHTML = `<div class="hex"><div class="hex-inner rainbow-hex" onclick="applyPreset('#111','#333', '#ffb3ba', '#bae1ff', '#ffffba')"></div></div>`;
    els.hexContainer.appendChild(rainbowRow);

    window.resetDev = () => { applyPreset('#a18cd1', '#fbc2eb', '#8ec5fc', '#e0c3fc', '#99ddff'); showToast("Reset"); };

    function loadDev() {
        const c1 = localStorage.getItem('d_c1') || '#a18cd1';
        const c2 = localStorage.getItem('d_c2') || '#fbc2eb';
        document.documentElement.style.setProperty('--c1', c1); document.documentElement.style.setProperty('--c2', c2);
        updateDev(true);
    }
    
    function updateDev(fromLoad=false) {
        const metaTheme = document.getElementById('theme-color-meta');
        if(metaTheme) metaTheme.setAttribute('content', document.documentElement.getAttribute('data-theme').includes('dark') ? '#000000' : localStorage.getItem('d_c1')||'#a18cd1');
    }

    // Animation Setup
    let currentAnim = localStorage.getItem('anim_type_v67') || 'nebula';
    function setAnim(type) {
        currentAnim = type; localStorage.setItem('anim_type_v67', type);
        document.querySelectorAll('.anim-option').forEach(el => el.classList.remove('active'));
        document.getElementById(`anim-${type}`).classList.add('active');
    }
    setAnim(currentAnim);
    
    let globalStream, mediaRecorder, chunks = [], audioCtx, analyser, dataArray;
    let isRecording = false, isPaused = false, isCancelled = false;
    let sessionStartTime = 0, partStartTime = 0, totalPauseDelta = 0, partPauseDelta = 0, pauseStart = 0, timerInt;
    let micsLoaded = false;
    
    let currentSessionId = null; let currentPart = 1; let isAutoCutting = false;
    let pendingTranscriptions = 0; let sessionBlobs = []; let activeCost = 0; 

    if(HARDCODED_KEY.length > 5) { els.apiKey.value = HARDCODED_KEY; } else { els.apiKey.value = localStorage.getItem("key_v38") || ""; }

    function migrateHistory() { let h = localStorage.getItem("hist_master"); if (!h) { h = "[]"; localStorage.setItem("hist_master", h); } } 
    migrateHistory(); loadDev();
    
    // Hard-Sortierung (Neueste immer oben)
    function saveToHistory(id, text, ts, blobs, cost, durationStr) { 
        let h = JSON.parse(localStorage.getItem("hist_master")||"[]"); 
        h.push({ id, text, ts, cost, durationStr }); 
        h.sort((a, b) => b.id - a.id); // Descending (H√∂chste ID zuerst)
        if(h.length > 30) h.pop(); 
        localStorage.setItem("hist_master", JSON.stringify(h)); 
    }
    function loadHistory() { 
        let h = JSON.parse(localStorage.getItem("hist_master")||"[]");
        h.sort((a, b) => b.id - a.id); // Neueste an Index 0
        els.feed.innerHTML = "";
        h.forEach(e => createHistoryEntry(e.id, e.ts, e.text, [], e.cost || 0, e.durationStr || "00:00", true)); 
    }
    loadHistory();

    function resizeCanvas() { els.canvas.width = window.innerWidth; els.canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    function autoResizeText(textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; }

    // Advanced Animations
    let smoothedVol = 0; let timeAccum = 0;
    function initVisualizer() {
        const ctx = els.canvas.getContext('2d'); resizeCanvas();
        function draw() {
            requestAnimationFrame(draw);
            const w = els.canvas.width; const h = els.canvas.height;
            const isDark = document.documentElement.getAttribute('data-theme').includes('dark');
            ctx.fillStyle = isDark ? '#000000' : '#ffffff';
            ctx.fillRect(0, 0, w, h); 

            let rawVol = 0;
            if(analyser && isRecording && !isPaused) {
                if(dataArray) { analyser.getByteFrequencyData(dataArray); let sum = 0; for(let i=0; i<dataArray.length; i++) sum += dataArray[i]; rawVol = (sum / dataArray.length); }
                timeAccum += 0.006 + (rawVol * 0.0003); // Starke Reaktion auf Stimme
            } else { timeAccum += 0.004; } 

            smoothedVol = smoothedVol * 0.85 + (Math.min(rawVol / 100, 1.0)) * 0.15; 
            const intensity = 1.0 + (smoothedVol * 2.0); // Viel extremer bei Ton
            const maxDim = Math.max(w, h);

            const colors = [localStorage.getItem('d_b1')||'#8ec5fc', localStorage.getItem('d_b2')||'#e0c3fc', localStorage.getItem('d_b3')||'#99ddff', localStorage.getItem('d_c1')||'#a18cd1'];

            if(currentAnim === 'nebula') {
                const baseRadius = maxDim * 0.6; 
                for(let i=0; i<6; i++) { // Mehr Partikel
                    let cIdx = i % colors.length;
                    let r = baseRadius * intensity * (0.8 + (i*0.1));
                    let x = w/2 + Math.cos(timeAccum * (0.4 + i*0.1) + i) * w * 0.5;
                    let y = h/2 + Math.sin(timeAccum * (0.5 + i*0.1) - i) * h * 0.5;
                    const grad = ctx.createRadialGradient(x, y, 0, x, y, r);
                    grad.addColorStop(0, colors[cIdx] + 'ff'); grad.addColorStop(1, colors[cIdx] + '00');
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
                }
            } else if (currentAnim === 'aurora') {
                for(let i=0; i<5; i++) {
                    let cIdx = i % colors.length;
                    let bandW = w * 1.0 * intensity;
                    let x = (w/5) * i + Math.sin(timeAccum + i)*200;
                    let yOffset = Math.sin(timeAccum * 0.5 + i) * h * 0.5;
                    const grad = ctx.createLinearGradient(x - bandW/2, 0, x + bandW/2, h);
                    grad.addColorStop(0, colors[cIdx] + '00'); grad.addColorStop(0.5, colors[cIdx] + 'cc'); grad.addColorStop(1, colors[cIdx] + '00');
                    ctx.fillStyle = grad; ctx.fillRect(0, yOffset - h*0.5, w, h*2);
                }
            } else if (currentAnim === 'lava') {
                const baseRadius = maxDim * 0.4;
                for(let i=0; i<8; i++) {
                    let cIdx = i % colors.length;
                    let r = baseRadius * (0.5 + intensity * 0.4);
                    let x = w/2 + Math.cos(timeAccum * 0.6 + i*15) * w * 0.4;
                    // Steigen von unten nach oben
                    let y = h + r - ((timeAccum * 150 + i*300) % (h + r*2)); 
                    const grad = ctx.createRadialGradient(x, y, 0, x, y, r);
                    grad.addColorStop(0, colors[cIdx] + 'ee'); grad.addColorStop(1, colors[cIdx] + '00');
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
                }
            }
        } draw();
    } initVisualizer();

    async function loadMicrophones() {
        if(micsLoaded) return;
        try {
            const devices = await navigator.mediaDevices.enumerateDevices(); const audioDevs = devices.filter(d => d.kind === 'audioinput');
            if(audioDevs.length > 0) {
                els.micSelect.innerHTML = '<option value="default">Default</option>';
                audioDevs.forEach((d, i) => {
                    let cleanName = d.label.replace(/\s*\([a-fA-F0-9]{4}:[a-fA-F0-9]{4}\)\s*/g, '').replace(/Default - /i, '').trim();
                    const opt = document.createElement('option'); opt.value = d.deviceId; opt.text = `${cleanName.substring(0,12)}..`;
                    els.micSelect.appendChild(opt);
                }); micsLoaded = true;
            }
        } catch(e) {}
    }

    let wakeLock = null;
    async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
    function releaseWakeLock() { if (wakeLock !== null) { wakeLock.release().then(() => wakeLock = null); } }

    els.btnMain.onclick = () => { if(!isRecording) startRec(); else stopRec(); };
    els.btnPause.onclick = () => { if(isRecording && !isPaused) pauseRec(); else if(isPaused) resumeRec(); };
    
    window.cancelRec = (btn) => { 
        if(!btn.classList.contains('confirm')) {
            btn.classList.add('confirm'); btn.innerHTML = '<span style="font-size:1rem; font-weight:bold;">üóëÔ∏è?</span>'; btn.style.color = 'white'; btn.style.background = 'var(--danger)';
            setTimeout(() => { 
                if(isRecording || isPaused) { btn.classList.remove('confirm'); btn.style.background = ''; btn.style.color = 'var(--danger)'; btn.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'; }
            }, 3000); return;
        }
        isCancelled = true; if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); 
        btn.classList.remove('confirm'); btn.style.background = ''; btn.style.color = 'var(--danger)'; btn.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
    };

    function setMainButtonState(state) {
        if(state === 'idle') {
            els.iconMain.innerHTML = '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>'; 
            els.btnMain.className = 'btn-circle'; els.btnMain.disabled = false;
            els.btnPause.classList.remove('visible'); els.btnCancel.classList.remove('visible'); 
        } else if (state === 'recording') {
            els.iconMain.innerHTML = '<rect x="6" y="6" width="12" height="12" rx="2" ry="2" fill="currentColor" stroke="none"></rect>'; 
            els.btnMain.className = 'btn-circle state-recording'; els.btnMain.disabled = false;
            els.iconPause.innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>'; 
            els.btnPause.className = 'btn-circle side-btn visible'; els.btnCancel.className = 'btn-circle side-btn visible'; 
            els.timer.style.color = "var(--text)";
        } else if (state === 'paused') {
            els.iconPause.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>'; 
            els.btnPause.className = 'btn-circle side-btn visible state-paused'; els.timer.style.color = "var(--warn)"; 
        }
    }

    function updateStatusBadges() {
        els.badgeListen.style.display = isRecording ? 'flex' : 'none';
        els.badgeTranscribe.style.display = pendingTranscriptions > 0 ? 'flex' : 'none';
    }

    async function startRec() {
        els.btnMain.disabled = true;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: els.micSelect.value !== 'default' ? { deviceId: { exact: els.micSelect.value } } : true });
            loadMicrophones(); globalStream = stream; requestWakeLock();
            
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); analyser = audioCtx.createAnalyser(); analyser.fftSize = 64; audioCtx.createMediaStreamSource(stream).connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); } catch(e) { analyser = null; }

            chunks = []; isCancelled = false; let options = { bitsPerSecond: 32000 };
            if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) options.mimeType='audio/webm;codecs=opus';
            
            if(!isAutoCutting) { 
                currentSessionId = Date.now(); currentPart = 1; sessionBlobs = []; activeCost = 0; pendingTranscriptions = 0;
                sessionStartTime = Date.now(); totalPauseDelta = 0; 
                els.activeText.value = ''; updateLiveStats();
                els.activeEntry.style.display = 'flex';
                autoResizeText(els.activeText);
            }
            partStartTime = Date.now(); partPauseDelta = 0;
            isRecording = true; updateStatusBadges();

            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            
            mediaRecorder.onstop = () => {
                if(isCancelled) { resetUI(); els.activeEntry.style.display = 'none'; updateStatusBadges(); return; }
                const blob = new Blob(chunks, { type: chunks[0].type });
                sessionBlobs.push(blob);
                
                const partSec = Math.floor((Date.now() - partStartTime - partPauseDelta)/1000);
                activeCost += (partSec / 60) * 0.6; 
                const totalSec = Math.floor((Date.now() - sessionStartTime - totalPauseDelta)/1000);
                const finalDurationStr = `${Math.floor(totalSec/60).toString().padStart(2,'0')}:${(totalSec%60).toString().padStart(2,'0')}`;

                const wasAutoCut = isAutoCutting;
                processSessionAudio(blob, currentPart, wasAutoCut);

                if(isAutoCutting) {
                    isAutoCutting = false; chunks = []; currentPart++;
                    mediaRecorder.start(); partStartTime = Date.now(); partPauseDelta = 0; 
                } else {
                    resetUI(); 
                    finalizeSessionWhenReady(currentSessionId, sessionBlobs, activeCost, finalDurationStr);
                }
            };
            
            mediaRecorder.start(); isPaused = false; 
            if(!timerInt) timerInt = setInterval(updateTimer, 1000); setMainButtonState('recording');
        } catch(e) { setMainButtonState('idle'); els.btnMain.disabled = false; } 
    }

    function performAutoCut() { 
        if(mediaRecorder && mediaRecorder.state === 'recording') { 
            isAutoCutting = true; 
            els.badgeCut.style.display = 'flex'; els.badgeListen.style.display = 'none';
            mediaRecorder.stop(); 
            setTimeout(() => { els.badgeCut.style.display = 'none'; updateStatusBadges(); }, 1200);
        } 
    }
    
    function pauseRec() { if(mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.pause(); isPaused=true; pauseStart=Date.now(); setMainButtonState('paused'); } }
    function resumeRec() { if(mediaRecorder && mediaRecorder.state === "paused") { mediaRecorder.resume(); isPaused=false; const delta = Date.now() - pauseStart; totalPauseDelta += delta; partPauseDelta += delta; setMainButtonState('recording'); } }
    function stopRec() { if(mediaRecorder) { isAutoCutting = false; isRecording = false; updateStatusBadges(); mediaRecorder.stop(); els.btnMain.disabled=true; } }

    function updateTimer() {
        if(isPaused) return; 
        const totalSec = Math.floor((Date.now() - sessionStartTime - totalPauseDelta)/1000);
        const partSec = Math.floor((Date.now() - partStartTime - partPauseDelta)/1000);
        
        let cutMins = cutOptions[currentCutIdx];
        if(cutMins > 0 && partSec >= cutMins * 60) { performAutoCut(); return; }

        els.timer.innerText = `${Math.floor(totalSec/60).toString().padStart(2,'0')}:${(totalSec%60).toString().padStart(2,'0')}`;
        updateLiveStats();
    }

    function updateLiveStats() {
        const txt = els.activeText.value.trim(); 
        const words = txt ? txt.split(/\s+/).length : 0;
        els.liveWords.innerText = `${words} W`; 
        els.liveTokens.innerText = `${Math.ceil(words / 0.75)} T`;
        els.livePages.innerText = `${(words / 250).toFixed(1)} S`;
        els.liveCost.innerText = `~${activeCost.toFixed(1)} ct`;
    }

    function resetUI() { 
        isRecording=false; isPaused=false; isAutoCutting=false; 
        clearInterval(timerInt); timerInt=null; 
        setMainButtonState('idle'); els.timer.innerText="00:00"; 
        releaseWakeLock(); if(globalStream) globalStream.getTracks().forEach(t=>t.stop()); 
        updateStatusBadges();
        els.btnMain.disabled = false; // Important fix for double click
    }

    function showToast(msg) {
        els.toastMsg.innerText = msg; els.toast.className = 'visible'; setTimeout(() => { els.toast.className = ''; }, 2500);
    }

    async function processSessionAudio(blob, part, wasAutoCut) {
        pendingTranscriptions++; updateStatusBadges();
        if(!els.apiKey.value) { els.activeText.value += `\n[Wartet auf API Key...]`; autoResizeText(els.activeText); pendingTranscriptions--; updateStatusBadges(); return; }
        
        const fd = new FormData(); fd.append("file", blob, `audio.webm`); fd.append("model", "whisper-1");
        try {
            const res = await fetch("https://api.openai.com/v1/audio/transcriptions", { method: "POST", headers: { "Authorization": `Bearer ${els.apiKey.value}` }, body: fd });
            const data = await res.json();
            if(res.ok) {
                const newText = part > 1 ? `\n---\n${data.text}` : data.text;
                els.activeText.value = (els.activeText.value + newText).trim();
                updateLiveStats(); autoResizeText(els.activeText);
                navigator.clipboard.writeText(els.activeText.value); 
            } else { els.activeText.value += `\n[Error: ${data.error?.message}]`; autoResizeText(els.activeText); }
        } catch(e) { els.activeText.value += `\n[Netzwerk-Fehler]`; autoResizeText(els.activeText); }
        pendingTranscriptions--; updateStatusBadges();
    }

    function finalizeSessionWhenReady(sId, bList, cost, durationStr) {
        if(pendingTranscriptions > 0) { setTimeout(() => finalizeSessionWhenReady(sId, bList, cost, durationStr), 1000); return; }
        
        const finalTxt = els.activeText.value.trim();
        if(finalTxt) {
            const startTs = new Date(sessionStartTime).toLocaleString('de-DE', { timeStyle: 'short' });
            const endTs = new Date().toLocaleString('de-DE', { timeStyle: 'short' });
            const tsFull = `${new Date().toLocaleDateString('de-DE', {dateStyle:'short'})} | ${startTs} - ${endTs}`;
            
            saveToHistory(sId, finalTxt, tsFull, bList, cost, durationStr);
            createHistoryEntry(sId, tsFull, finalTxt, bList, cost, durationStr);
            
            navigator.clipboard.writeText(finalTxt); 
            if(document.hasFocus()) { showToast("Kopiert & Gespeichert!"); }
            if(isAutoSave) dlEntryZip(sId);
        }
        els.activeEntry.style.display = 'none'; 
    }

    window.fixDuration = function(audio) { if(audio.duration === Infinity || isNaN(audio.duration)) { audio.currentTime = 1e101; audio.ontimeupdate = function() { this.ontimeupdate = null; this.currentTime = 0; } } }

    function createHistoryEntry(id, ts, text, blobs=[], cost=0, durationStr="00:00", isLoad=false) {
        const d = document.createElement('div'); d.className = 'entry'; d.id = `e-${id}`;
        d.audioBlobs = blobs;
        const words = text ? text.split(/\s+/).length : 0;
        const tokens = Math.ceil(words / 0.75);
        const pages = (words / 250).toFixed(1);
        
        let audioHtml = "";
        if(blobs.length > 0) {
            let players = blobs.map((b, i) => `<div class="audio-part"><span>T ${i+1}</span><audio controls playsinline src="${URL.createObjectURL(b)}" onloadedmetadata="window.fixDuration(this)"></audio></div>`).join("");
            audioHtml = `<details class="custom-accordion"><summary><svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg> Audios (${blobs.length})</summary><div class="audio-list">${players}</div></details>`;
        }

        d.innerHTML = `
            <div class="entry-header">
                <div class="entry-meta-info">
                    <span class="date-badge"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> ${ts}</span>
                    <div class="stats-badges" style="margin-top:4px;">
                        <span class="stat-pill">‚è± ${durationStr}</span>
                        <span class="stat-pill">${words} W</span><span class="stat-pill">${tokens} T</span>
                        <span class="stat-pill">${pages} S</span><span class="stat-pill">~${cost.toFixed(1)} ct</span>
                    </div>
                </div>
                <div class="entry-actions">
                    <button class="mini-btn action" onclick="dlEntryZip(${id})" title="Paket Download (ZIP)"><svg viewBox="0 0 24 24">${svgZip}</svg></button>
                    <button class="mini-btn" onclick="doCopy(${id}, true)" title="Text kopieren"><svg viewBox="0 0 24 24">${svgCopy}</svg></button>
                    <button class="mini-btn" onclick="dlTxt(${id})" title="Text als .txt"><svg viewBox="0 0 24 24">${svgTxt}</svg></button>
                    ${blobs.length > 0 ? `<button class="mini-btn" onclick="dlAudio(${id})" title="Audios laden"><svg viewBox="0 0 24 24">${svgAudio}</svg></button>` : ''}
                    <button class="mini-btn safe" onclick="retrySession(${id})" title="Retry Audio"><svg viewBox="0 0 24 24">${svgRetry}</svg></button>
                    <button class="mini-btn danger" onclick="delEntry(${id}, this)" title="L√∂schen"><svg viewBox="0 0 24 24">${svgTrash}</svg></button>
                </div>
            </div>
            <textarea id="txt-${id}" class="seamless-text" oninput="autoResizeText(this)" style="max-height: none; overflow-y: hidden;">${text}</textarea>
            ${audioHtml}
        `;
        
        if (isLoad) { els.feed.appendChild(d); } else { els.feed.prepend(d); }
        setTimeout(() => { autoResizeText(d.querySelector('textarea')); }, 50);
    }

    window.doCopy = (id, showPopup=false) => { navigator.clipboard.writeText(document.getElementById(`txt-${id}`).value); if(showPopup) { showToast("Kopiert!"); } };
    window.delEntry = (id, btn) => { 
        if(!btn.classList.contains('confirm')) {
            btn.classList.add('confirm'); btn.innerHTML = '<span style="font-size:0.9rem; font-weight:bold;">?</span>'; btn.style.background = 'var(--danger)'; btn.style.color = 'white';
            setTimeout(() => { if(document.getElementById(`e-${id}`)) { btn.classList.remove('confirm'); btn.style.background = ''; btn.style.color = 'var(--text)'; btn.innerHTML = `<svg viewBox="0 0 24 24">${svgTrash}</svg>`; } }, 3000); return;
        }
        document.getElementById(`e-${id}`).remove(); let h = JSON.parse(localStorage.getItem("hist_master")||"[]"); localStorage.setItem("hist_master", JSON.stringify(h.filter(x => x.id != id))); 
    };

    window.dlTxt = (id) => { download(new Blob([document.getElementById(`txt-${id}`).value]), `transkript_${id}.txt`); };
    window.dlAudio = async (id) => { 
        const el = document.getElementById(`e-${id}`); if(!el.audioBlobs || el.audioBlobs.length === 0) return;
        if(el.audioBlobs.length === 1) { download(el.audioBlobs[0], `rec_${id}.${el.audioBlobs[0].type.includes('mp4') ? 'mp4' : 'webm'}`); } 
        else { showToast("Zip wird erstellt..."); if(!window.JSZip) return; const zip = new JSZip(); el.audioBlobs.forEach((blob, index) => { zip.file(`rec_${id}_part${index+1}.${blob.type.includes('mp4') ? 'mp4' : 'webm'}`, blob); }); download(await zip.generateAsync({type:"blob"}), `Session_${id}_Audios.zip`); }
    };
    window.dlEntryZip = async (id) => {
        if(!window.JSZip) return; showToast("Paket wird gepackt..."); const zip = new JSZip(); const el = document.getElementById(`e-${id}`); const txt = document.getElementById(`txt-${id}`).value; const words = txt ? txt.split(/\s+/).length : 0;
        zip.file(`transkript_${id}.txt`, txt);
        zip.file(`stats.txt`, `--- Statistik ---\n\nW√∂rter: ${words}\nToken: ${Math.ceil(words/0.75)}\nSeiten: ${(words/250).toFixed(1)}\nID: ${id}`);
        if(el.audioBlobs && el.audioBlobs.length > 0) { el.audioBlobs.forEach((blob, index) => { zip.folder("audio").file(`rec_${id}_part${index+1}.${blob.type.includes('mp4') ? 'mp4' : 'webm'}`, blob); }); }
        download(await zip.generateAsync({type:"blob"}), `Memo_Backup_${id}.zip`);
    };
    window.retrySession = async (id) => { 
        const el = document.getElementById(`e-${id}`); if(!el.audioBlobs || el.audioBlobs.length === 0) { return; }
        const blob = el.audioBlobs[el.audioBlobs.length - 1]; showToast("Starte Retry...");
        els.activeEntry.style.display = 'flex'; els.activeText.value = document.getElementById(`txt-${id}`).value; currentSessionId = id; processSessionAudio(blob, el.audioBlobs.length, false); 
    };
    window.dlAllZip = async () => {
        if(!window.JSZip) return; const zip = new JSZip(); let allTxt = "--- PROTOKOLL ---\n\n";
        document.querySelectorAll('.entry').forEach(e => {
            if(e.id === "activeEntry") return;
            const id = e.id.replace('e-',''); const txt = e.querySelector('textarea').value; const ts = e.querySelector('.date-badge').innerText;
            allTxt += `[${ts}]\n${txt}\n\n---\n\n`; 
            if(e.audioBlobs) { e.audioBlobs.forEach((blob, index) => { zip.folder("audio").file(`rec_${id}_part${index+1}.webm`, blob); }); }
        });
        zip.file("Alle_Transkripte.txt", allTxt);
        setTimeout(async () => { download(await zip.generateAsync({type:"blob"}), `Master_Backup_${new Date().toISOString().replace(/[:.]/g, '-').slice(0,16)}.zip`); }, 1000);
    };

    els.fileUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const id = Date.now(); const ts = new Date().toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
        createHistoryEntry(id, ts, "L√§dt...", [file]);
        const textArea = document.getElementById(`txt-${id}`); const fd = new FormData(); fd.append("file", file, file.name); fd.append("model", "whisper-1");
        try {
            const res = await fetch("https://api.openai.com/v1/audio/transcriptions", { method: "POST", headers: { "Authorization": `Bearer ${els.apiKey.value}` }, body: fd });
            const data = await res.json();
            if(res.ok) { textArea.value = data.text; saveToHistory(id, data.text, ts, [file], 0, "Upload"); autoResizeText(textArea); } else { textArea.value = `Error: ${data.error?.message}`; }
        } catch(e) { textArea.value = `Fehler: ${e.message}`; }
        els.fileUpload.value='';
    });

    function download(blob, name) { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
</script>
</body>
</html>